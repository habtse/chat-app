version: '3.8'

services:
  # PostgreSQL Database Service
  db:
    image: postgres:14-alpine
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: shipperchat
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Backend API and WebSocket Service
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    restart: always
    ports:
      - "3001:3001"
    environment:
      # Database connection string using the service name 'db'
      DATABASE_URL: postgresql://user:password@db:5432/shipperchat?schema=public
      # Other environment variables from .env.example
      JWT_SECRET: a_strong_secret_key_for_jwt
      JWT_ACCESS_TOKEN_EXPIRY: 15m
      JWT_REFRESH_TOKEN_EXPIRY: 7d
      FRONTEND_URL: http://localhost:3000
    depends_on:
      - db
    # Command to wait for the database and then run Prisma migrations/push
    command: sh -c "sleep 5 && npm run db:push && npm run start"

  # Frontend Next.js Application Service
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    restart: always
    ports:
      - "3000:3000"
    environment:
      # Frontend environment variables
      NEXT_PUBLIC_API_BASE_URL: http://localhost:3001/api/v1
      NEXT_PUBLIC_WS_URL: ws://localhost:3001/ws
    depends_on:
      - backend

volumes:
  postgres_data:
